% This is LLNCS.DEM the demonstration file of
% the LaTeX macro package from Springer-Verlag
% for Lecture Notes in Computer Science,
% version 2.4 for LaTeX2e as of 16. April 2010
%
%\PassOptionsToPackage{table,x11names}{xcolor}
\documentclass{llncs}
%
\usepackage{makeidx}  % allows for indexgeneration
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{pgfplots}
\usepackage{filecontents}
%\usepackage{pstricks}
\usepackage{booktabs}
%\usepackage[table]{xcolor}
\usepackage{listings}
\lstdefinestyle{mystyle}{
	%backgroundcolor=\color{backcolour},   
	%commentstyle=\color{codegreen},
	%keywordstyle=\color{magenta},
	%numberstyle=\tiny\color{codegray},
	%stringstyle=\color{codepurple},
	basicstyle=\scriptsize,
	breakatwhitespace=false,         
	breaklines=true,                 
	captionpos=b,                    
	keepspaces=true,                 
	%numbers=left,                    
	%numbersep=5pt,                  
	showspaces=false,                
	showstringspaces=false,
	showtabs=false,                  
	tabsize=2,
	%frame=single
}

\lstset{style=mystyle}

% ----------------------
% fancyref
\usepackage[plain]{fancyref}

\newcommand*{\fancyrefalglabelprefix}{alg}
\newcommand*{\fancyreflstlabelprefix}{lst}
\newcommand*{\fancyrefapplabelprefix}{app}

\fancyrefaddcaptions{english}{%
	\providecommand*{\frefalgname}{algorithm}%
	\providecommand*{\Frefalgname}{Algorithm}%
	%
	\providecommand*{\freflstname}{listing}%
	\providecommand*{\Freflstname}{Listing}%
	%
	\providecommand*{\frefappname}{appendix}%
	\providecommand*{\Frefappname}{Appendix}%
}%

\frefformat{plain}{\fancyrefalglabelprefix}{%
	\frefalgname\fancyrefdefaultspacing#1%
}%
\Frefformat{plain}{\fancyrefalglabelprefix}{%
	\Frefalgname\fancyrefdefaultspacing#1%
}
\frefformat{vario}{\fancyrefalglabelprefix}{%
	\frefalgname\fancyrefdefaultspacing#1#3%
}%
\Frefformat{vario}{\fancyrefalglabelprefix}{%
	\Frefalgname\fancyrefdefaultspacing#1#3%
}%

\frefformat{plain}{\fancyreflstlabelprefix}{%
	\freflstname\fancyrefdefaultspacing#1%
}%
\Frefformat{plain}{\fancyreflstlabelprefix}{%
	\Freflstname\fancyrefdefaultspacing#1%
}
\frefformat{vario}{\fancyreflstlabelprefix}{%
	\freflstname\fancyrefdefaultspacing#1#3%
}%
\Frefformat{vario}{\fancyreflstlabelprefix}{%
	\Freflstname\fancyrefdefaultspacing#1#3%
}%

\frefformat{plain}{\fancyrefapplabelprefix}{%
	\frefappname\fancyrefdefaultspacing#1%
}%
\Frefformat{plain}{\fancyrefapplabelprefix}{%
	\Frefappname\fancyrefdefaultspacing#1%
}
\frefformat{vario}{\fancyrefapplabelprefix}{%
	\frefappname\fancyrefdefaultspacing#1#3%
}%
\Frefformat{vario}{\fancyrefapplabelprefix}{%
	\Frefappname\fancyrefdefaultspacing#1#3%
}%


% line breaks in table cells:

\usepackage{makecell}
\renewcommand\cellalign{lt}


\captionsetup{compatibility=false}
%

\newcommand{\dummyfig}[3]{
	\centering
	\fbox{
		\begin{minipage}[c][#1\textheight][c]{#2\textwidth}
			\centering{#3}
		\end{minipage}
	}
}
\begin{document}
%
\frontmatter          % for the preliminaries
%
\pagestyle{headings}  % switches on printing of running heads

\mainmatter              % start of the contributions
%
\title{Bringing Back Structure to Free Text Email Conversations with Recurrent Neural Networks}
%
\titlerunning{Disentangling Email Conversations}  % abbreviated title (for running head)
%                                     also used for the TOC unless
%                                     \toctitle is used
%
%\author{Tim Repke \and Ralf Krestel}
\author{First Author \and Second Author}
%
%\authorrunning{Tim Repke et al.} % abbreviated author list (for running head)
\authorrunning{First Author et al.}
%
%%%% list of authors for the TOC (use if author list has to be modified)
%\tocauthor{Tim Repke, Ralf Krestel}
\tocauthor{First Author, Second Author}
%
%\institute{Hasso Plattner Institute, Potsdam, Germany\\
%\email{(tim.repke|ralf.krestel)@hpi.de}}

\institute{A Research Institute, City, Country\\
	\email{(second.author|first.author)@domain.tld}}

\maketitle              % typeset the title of the contribution

\begin{abstract}
The abstract should summarize the contents of the paper
using at least 70 and at most 150 words. It will be set in 9-point
font size and be inset 1.0 cm from the right and left margins.
There will be two blank lines before and after the Abstract. \dots
%\keywords{computational geometry, graph theory, Hamilton cycles}
\end{abstract}
%
\section{Introduction}
Emails are and important part of day to day business communication, hence their analysis inspired research from a variety of disciplines.
Many of those solely use information contained in the well structured email protocol headers, such as in Social Network Analysis, User Profiling, or Behaviour Analysis.

However, a lot more information remains hidden in the free text body of an email, which contains additional meta-data about a discussion in the form of quoted messages that are forwarded or replied to.
In the early days of email communication, users followed clear rules such as prefixing quoted text with angle brackets ($>$).

Nowadays though, due to the diversity of email programs, formatting standards, and the freedom to edit quoted text, identifying the different parts of a message body is a surprisingly challenging task.
Email programs like Outlook, Thunderbird, or even online services such as Gmail usually group emails into conversations and attempt to hide quoted parts.
To do so, they rely on having the preceding emails that are matched by subject and sender, but fail when the subject or quoted text was edited.

We propose a neural network based approach and enable downstream tasks to utilise otherwise hidden or noisy information and overcome problems of error-prone rule-based approaches.
Further we show improvements in flexibility and performance over earlier work on similar tasks.


%früher: emails strukturiert, eingerückt, etc; heute: sehr frei/divers, geht nicht mehr mit regeln; Ansatz: deep learning

%ALTERNATIV:

%emails used for SNA, classification, behaviour, profiling, and more
%most based on full mails, but conversations contain quoted messaged including additional metadata; distracts downstream tasks

%our goal: clean up emails properly, don't assume full corpus, therefore keep all information

\paragraph{Problem statement}
In this paper we propose approaches to extract the inherent structure of free text emails containing a conversation thread composed of consecutive quoted or forwarded messages.
Components of an email are referred to as \textit{zones} similar to definition used by Lampert et al~\cite{zones}.
We assume that a conversation thread is represented as a sequence of \textit{header and body blocks}, which is consistent with emails in the Enron corpus.
A pair of corresponding header and body is called \textit{conversational part} or \textit{message}.

Hereby client headers are blocks of meta-data automatically inserted by an email program, usually containing information on the sender, recipient, date, and subject of the quoted email.
Usually the header indicates, whether the subsequent message body was forwarded or replied to by the text above.
Bodies are the actual written messages, which on reply or forward are quoted below the newer message.

Message bodies are further separated into a \textit{greeting} (such as a formal or informal address of the recipient at the beginning of the message), \textit{authored text} (the actual message), \textit{signoff} (closing words of the message), and a \textit{signature} (containing contact information, advertising, or legal disclaimers).

Without loss of generality, we consider exactly one zone type per line as \Fref{fig:examplemail} exemplary shows.
In case of conflicts, the predominant or detailed type is used.


%describe task: split mails in different parts of the thread; parse meta information in intermediate headers
%- use term: zone
%- email as chain of header/body
%- within body: greetings, signoff, signature, text
%- header: contains metadata like from, to, when subject


\begin{figure}
% potential example listings:
% presto-k/discussion_threads/23.
% skilling-j/all_documents/1529.
% skilling-j/discussion_threads/1092.
\centering
\begin{tabular}{|c|}
	\hline 
	\scriptsize{
	\begin{tabular*}{\textwidth}{@{\extracolsep{\fill}}lr}
		\makecell{
			\textit{From:} Alice\\ 
			\textit{To:} Bob, Brian\\
			\textit{Subject:} RE: Telephone Call with Jerry Murdock
		} &
		\hspace*{\fill} { \textit{Sent:} Mon, 14 May 2001 07:15 AM}
	\end{tabular*}
}
	\\ 
	\hline 
	\scriptsize{
	\begin{tabular*}{\textwidth}{l|l} 
		Body           & Thank you for your help. \\
		Body           & \\
		Body/Signature & ISC Hotline\\\hline
		Header         & 03/15/2001 10:32 AM \\
		Header         & \\
		Header         & Sent by: Randi Howard \\
		Header         & To: Jeff Skilling/Corp/Enron@ENRON\\
		Header         & cc:\\
		Header         & \\
		Header         & Subject: Re: My "P" Number\\\hline
		Body           & \\
		Body/Greeting  & Mr. Skilling: \\
		Body           & \\
		Body           & Your P number is P00500599.  For your convenience, you can also go to\\
		Body           & http://isc.enron.com/ under Site Highlights and reset your password or \\
		Body           & find your "P" number.\\
		Body           & \\
		Body/Signoff   & Thanks,\\
		Body/Signoff   & \\
		Body/Signoff   & Randi Howard\\
		Body/Signature & ISC HOTLINE\\
		Body           & \\\hline
		Header         & From:  Jeff Skilling                           03/15/2001 10:01 AM \\
		Header         & \\
		Header         & To: ISC Hotline/Corp/Enron@Enron\\
		Header         & cc:\\
		Header         & \\
		Header         & Subject: My "P" Number\\\hline
		Body           & \\
		Body           & Could you please forward my "P" number.  I am unable to get into the XMS \\
		Body           & system and need this ASAP.\\
		Body           & \\
		Body/Signoff   & Thanks for your help.\\
	\end{tabular*}
}
	\\ 
	\hline 
\end{tabular} 
\caption{Example email with zones; consecutive blank lines reduced to one}
\label{fig:examplemail}
\end{figure}





\section{Related Work}
% structure outline
% 1. show some tasks where authors found, that cleaning bodies is needed
% 2. highlight previous tasks/approaches (aligning, extract first message, multi zone)
% 2.1 jamison et al, yeh et al
% 2.2 carvalho using cperceptron (collins)
% 2.3 lampert et al zoning + request for action (highlight improvements through zoning first)
%     similarly rauscher et al (knowledge zoning), estival et al (author profiling)

Email corpora provide fascinating insights into human communication behaviour and therefore inspire research in many different areas.
Datasets such as the Enron or Avocado corpus~\cite{avocado,enron} provide real world information about business communication and contain not only professional emails, but also personal emails as well as spam.
For research on private emails, Ben Shneiderman published parts of his personal email archive~\cite{shneiderman}.
Another corpus used in related research is the Twenty Newsgroups dataset of emails sampled from newsgroups in the early 90s, however it only contains a few conversation threads~\cite{20news}.

A recent survey provides a detailed overview of the multitude email classification tasks alone~\cite{classification}.
Similarly interesting is the analysis of communication networks based on meta-data such as senders, recipients, and time.

Models based on the written content of emails may get confused by automatically inserted text blocks or quoted messages.
Thus, working with real world data requires the need to normalise data prior to the problem at hand.
Rauscher et al. developed an approach to detect zones inside work-related emails where relevant business knowledge may be found~\cite{rauscher2015context}.

In their work towards detecting emails containing requests for action, Lampert et al. compare the performance of their model on full emails (which may contain quoted text) against the same emails after automatically removing quoted sections and managed to achieve a relative error reduction by 40\%~\cite{rfa}.
Similar observations were made more recently predicting reply behaviour within the Avocado dataset~\cite{replying}.

We identified two approaches in the literature on separating email zones.
Assuming a complete email corpus, with the email archives of all users, a message in the outbox of one user is found in the inbox of another.
Likewise, quoted messages exist within the corpus as an original message from preceding communication.
By finding overlapping text passages across the corpus, Jamison et al. managed to resolve email threads of the Enron corpus almost perfectly~\cite{headerless}.
It has to be noted, that the claimed accuracy of almost 100\% was only tested on 20 email threads.

In order to reassemble email threads, Yeh et al. considered a similar approach with a more elaborate evaluation reaching an accuracy of 98\% separating email conversations into parts~\cite{similarity}.
To do so, they rely on additional meta information in emails sent through Microsoft Outlook (thread index) and rules that match specific client headers.
Thus, such an approach will not work on arbitrary emails, nor can it handle different localisation or edits by the user.

In this paper, we don't assume a complete corpus to be able to extract all information from only a single email archive or even a single email.
Carvalho and Cohn proposed Jangada, a system to remove quoted text and signature blocks from emails in the 20 newsgroup dataset~\cite{signature,20news}.
They first classify emails to find those, that contain quoted text or signatures and then classify each line individually using Conditional Random Fields and Collin's Perceptrons~\cite{crf, cperceptron}.
Reported accuracies range from 97\% to above 99\%.

Those result could not be reproduced on our dataset and modified task.
Similar findings are confirmed by Estival et al., who measured an accuracy of around 64\% using Jangada on Hotmail emails~\cite{profiling}.
Using CRFs, they managed to extract five different zones (author text, signature, advertisement, quoted text and reply lines) with an average accuracy of up to 88\%.

Most similar to our problem statement is the Zebra system by Lampert et al., which was developed for their previously mentioned work on requests for action~\cite{zones,rfa}.
The definition of zones is very similar to ours.

Contrary to our objectives, Zebra only tries to identify the zones within the very last message within an email thread and reject the rest as quoted text, whereas we aim to detect the zones across the entire email.
They describe graphic, orthographic, and lexical features to represent each line and classify line by line using an SVM reaching an average accuracy of 93\% on the two-zone task and 87\% on a nine-zone task.
It was found, that adding contextual features didn't improve the performance.
Comparing the performance by zone type, most problems are caused by signature lines (F-score around 60\%), signoffs (70\%) and attachments (69\%).

In our work, we aim to improve upon those results, while providing a system that is able to detect zones along the entire conversation thread contained in an email and not only the first part.
This way, even very small or incomplete datasets can be utilised for downstream tasks like social network analysis, speech acts and other research areas using email data.


%\cite{rfa} (detecting request for action) works better with zoning (see \cite{zones}), removes noise and focuses on text itself (excluding signature etc)

%\cite{zones} "Zebra" detects nine different zones, only last email in thread is considered, rest is quoted, classifies lines individually with features using SVM, three zones with 0.91 accuracy, 9 zones 0.87 accuracy; context features didn't add improve performance

%\cite{profiling} don't describe much, uses CRF inspired by \cite{signature}, five categories (author text, signature, advertisement, quoted text, reply lines), for eval using three zones with accuracy 0.88, F1 0.9, compared with \cite{signature} 0.64 and 0.75 on their data

%\cite{signature} "Jangada" detects signature and reply lines, only considers the last $n$ lines, using CRF with 0.97 accuracy, CPerceptron with 0.989 accuracy; extraction task only performed on mails known to contain signatures! used 20 newsgroup dataset \cite{20news}

%\cite{headerless} look for overlaps in enron dataset to split mails into parts of the conversation; closest to our task; we don't consider full dataset though (looking at each mail individually); their goal is to then reassemble the conversation threads, tested on 20 threads (leading to 465 mails), claim accuracy approaching 100\%

%\cite{similarity} similar to \cite{headerless}

%[citation needed] previous social network analysis wrong, because not considering full picture

%\cite{workhard} overview of recent technologies applied to enron and avocado (personal business classification + SNA)

%\cite{replying} also recent, on avocado, reply behaviour, only "main header"

%\cite{enron} enron corpus

%\cite{avocado} avocado corpus

%[citation needed] shneiderman corpus

%\cite{20news} 20 newsgroups

\section{Segmentation of Emails}
\label{sec:model}
Systems for email segmentation that are discussed earlier are based on hand written rules to match common structures directly or use them as features for machine learning models.
Such an approach will fail when client headers are localised, formats are changed or quoted messages are edited by users or get corrupted.
In most cases it may seem obvious to the human eye how to segment an email into client headers and quoted text even though different or corrupted formats are used.

However, even a sophisticated text parsing program will fail since client headers follow no standardised format.
Usually lines start with attribute keywords such as "From:" or "Subject:", however their value may span multiple lines and use varying delimiters.
This even makes it hard to detect the boundaries between header and body blocks, since one can not rely on the presence of keywords or well formed, deterministic schemas.

Therefore, our proposed model is based on multiple stages of neural network architectures which have proven their robustness in other applications.
In this section we describe how email text is represented and how classifiers can be used as a reliable and robust preprocessor for a simple program extract its inherent structure.

\subsection{Representation of Email Data}
In the initial stage of our system, the email text data is encoded into a low dimensional space.
This representation is used as input to later stages.
Here, the smallest fragment to be considered for email zoning are the lines in the email text.
The end of a line is delimited by a newline character (\textbackslash n).
Note however, that this may not necessarily be the same as floated lines displayed by an email program.
Analysis of the annotated data shows, that this granularity is sufficient for all header, body and signature zones as was assumed by other research on similar tasks.

Each line is encoded as a sequence of one-hot vectors representing respective characters.
We distinguish one hundred different case-sensitive alpha-numeric characters and basic ASCII symbols plus an out-of-scope placeholder.
This scope is sufficient for all email corpora we looked at, where only a negligible portion of characters exceeds this set.
For applications with Cyrillic, Arabic or other alphabets, this can easily be adapted.

Inspired by research on character-aware language models~\cite{char_nn}, we experiment with recurrent and convolutional neural networks.
The first model consists of a layer with varying number of gated recurrent units (GRU), where the last unit's output later serves as a fixed size embedding of the line.
The second model uses a two convolutional layers, which scan along the sequence of characters in a line and are intertwined by max-pooling and global-averaging layers finally leading into a densely connected layer, where the number of neurons corresponds to the embedding size.

In both models, the line representations are learnt in a supervised fashion.
During training, a densely connected layer with softmax activation is appended so that a classifier can be trained to distinguish between lines of corresponding zone types.
We found, that limiting the length of lines improves the accuracy of the embedding.
Optimal parameters of the topology such as the number of layers and embedding size are determined experimentally.


% parameters line num layers, embedding size etc experimentally determined
% limit line len
% learn char or line embedding

\subsection{Classification of Email Lines}
The previously described model for line representations is already constructed as a classification of lines into zones.
That way however, the context in which a line appears is missing, resulting in less ideal performance on ambiguous or deceptive cases.
Thus, we add a second stage to our model for sequence to sequence classification, where the input is a sequence of line embeddings of an email.
Best performance was achieved with a bidirectional GRU layer, where the hidden states of each direction are concatenated, followed by a Conditional Random Field (CRF) as model output.
Furthermore, as input we concatenate two embeddings, which are pre-trained on a two- and five-zone classification.
This way, we managed to improve the performance by implicitly helping the model understand the inherent ontology, where emails consist of header and body blocks and the body can be further segmented.

In sequence to sequence classification, recurrent neural networks only consider the previous hidden state but neglect the actually predicted label sequence.
By using a bidirectional layer, we observed a small improvement over a unidirectional recurrent layer, since each line's context reflects the previous and following lines.
Like in language models~\cite{lstm_crf,lstm_cnn_crf}, the addition of a CRF to the output shows further performance gains.

\begin{figure}
	\centering{
		\resizebox{0.8\textwidth}{!}{\input{model.pdf_tex}}
		\caption{Schematic model overview; Left side shows line embedding stage using the CNN approach, right side outlines email zoning model.}
		\label{fig:model}
	}
\end{figure}

\Fref{fig:model} shows a schematic overview of our proposed system of email zoning.
This model topology can be trained in two ways.
One would be to pre-train the embedding model and use it to encode the emails before passing them into the second stage of the system.
Another approach would be to directly connect the last layer before the classification layer of the embedding model to the first layer of the second model and continue training.
Training the entire model in one pass without pre-training the first stage model leads to unstable results and we observed best performance running both stages individually.

The sequence of zone types per line can be used to extract the conversational parts of an email and also separate the message from boilerplate content such as signatures, greetings and signoffs.
Consecutive lines with the same predicted zone type are taken into a block.
Further processing inevitably requires making some assumptions about the general structure of emails.
Based on the analysis of emails in the training data, we assume, that a body proceeds a header block.
Furthermore, we define that in-line replies with quoted parts belong to one message, which is not problematic though, since this would usually only appear in Usenet-style emails, which use indicators like repeated $>$ at the beginning of a line and therefore don't require sophisticated processing as presented here anyway.

Small errors in the prediction can be fixed heuristically, for example a block with a single line classified as header containing only the "Subject:" keyword likely is either a false positive or belongs to another block nearby.
Other similar rules can be constructed, but accumulatively reduce the initial robustness of the model due to added assumptions.
In the scope of our work we found, that combining this model as a pre-processor for finding related blocks and rules to parse them significantly improves the accuracy of downstream tasks like constructing communication graphs by parsing header blocks compared to a purely rule-based parsed without pre-processing.
We regard further processing as a task specific engineering problem.

% continue training for classification into header/body
% how to split thread based on that

%\subsection{Extraction of Email Meta-Data}
%continue training for further classification of body and header parts individually
\subsection{Selection of Model Parameters}
In the description of the proposed model, we highlighted parameters that can be adapted.
This includes the model for line representations in the first stage, limiting the length of each line, and finding the ideal dimension of line embeddings.
The configurations of the model topology exceeds the scope of this work, we therefore refer interested readers to the analysis of related models~\cite{char_nn,lstm_cnn_crf,lstm_crf}.
\begin{filecontents*}{dataevallines.csv}
	10,10,10,10,10,10,10,10,10,10,10,10,0.71,0.71,0.71,0.71,0.71,0.71,0.59,0.59,0.59,0.59,0.59,0.59,0.84,0.84,0.84,0.84,0.84,0.84,0.77,0.77,0.77,0.77,0.77,0.77,0.77,0.77,0.77,0.77,0.77,0.77,0.67,0.67,0.67,0.67,0.67,0.67,0.842061281337,0.842061281337,0.842061281337,0.842061281337,0.842061281337,0.842061281337,0.770334261838,0.770334261838,0.770334261838,0.770334261838,0.770334261838,0.770334261838
	20,20,20,20,20,20,20,20,20,20,20,20,0.93,0.94,0.93,0.93,0.93,0.93,0.85,0.85,0.86,0.85,0.85,0.84,0.93,0.94,0.93,0.94,0.93,0.93,0.71,0.79,0.83,0.76,0.74,0.62,0.93,0.94,0.93,0.94,0.93,0.93,0.76,0.81,0.84,0.79,0.77,0.69,0.933844011142,0.936908077994,0.933983286908,0.936490250696,0.927158774373,0.933844011142,0.711838440111,0.785515320334,0.833704735376,0.755849582173,0.735793871866,0.621727019499
	30,30,30,30,30,30,30,30,30,30,30,30,0.95,0.94,0.94,0.94,0.94,0.94,0.85,0.85,0.86,0.85,0.86,0.86,0.95,0.94,0.94,0.94,0.94,0.94,0.8,0.79,0.82,0.79,0.84,0.82,0.95,0.94,0.94,0.94,0.94,0.94,0.82,0.81,0.84,0.81,0.85,0.84,0.94721448468,0.940111420613,0.941364902507,0.942061281337,0.937883008357,0.936629526462,0.797075208914,0.790668523677,0.823259052925,0.791922005571,0.842757660167,0.824233983287
	40,40,40,40,40,40,40,40,40,40,40,40,0.95,0.95,0.93,0.89,0.94,0.95,0.82,0.86,0.87,0.86,0.87,0.87,0.95,0.95,0.93,0.85,0.94,0.95,0.52,0.83,0.82,0.83,0.8,0.82,0.95,0.95,0.93,0.86,0.94,0.95,0.59,0.85,0.84,0.84,0.83,0.84,0.947353760446,0.948328690808,0.927298050139,0.9059164345404,0.943871866295,0.953342618384,0.516155988858,0.833983286908,0.819777158774,0.833426183844,0.80069637883,0.820334261838
	50,50,50,50,50,50,50,50,50,50,50,50,0.94,0.95,0.95,0.95,0.93,0.93,0.86,0.87,0.87,0.87,0.88,0.87,0.94,0.95,0.95,0.95,0.93,0.93,0.81,0.83,0.8,0.83,0.81,0.82,0.94,0.95,0.95,0.95,0.93,0.93,0.83,0.84,0.82,0.85,0.84,0.84,0.938161559889,0.949860724234,0.95208913649,0.947075208914,0.92938718663,0.927158774373,0.806824512535,0.827576601671,0.79860724234,0.826601671309,0.81295264624,0.823955431755
	60,60,60,60,60,60,60,60,60,60,60,60,0.92,0.95,0.95,0.94,0.95,0.93,0.86,0.86,0.87,0.86,0.87,0.87,0.92,0.95,0.95,0.94,0.95,0.93,0.81,0.82,0.8,0.79,0.83,0.79,0.92,0.95,0.95,0.94,0.95,0.93,0.83,0.84,0.82,0.81,0.84,0.82,0.918245125348,0.950278551532,0.948746518106,0.942479108635,0.949442896936,0.933844011142,0.810167130919,0.824651810585,0.796796657382,0.785097493036,0.825626740947,0.785515320334
	70,70,70,70,70,70,70,70,70,70,70,70,0.95,0.94,0.95,0.95,0.95,0.94,0.87,0.83,0.84,0.87,0.83,0.86,0.95,0.94,0.95,0.95,0.95,0.94,0.79,0.49,0.67,0.83,0.6,0.81,0.95,0.94,0.95,0.95,0.95,0.94,0.82,0.57,0.73,0.85,0.66,0.83,0.948189415042,0.939554317549,0.952367688022,0.95348189415,0.953760445682,0.941922005571,0.793871866295,0.485097493036,0.751587743733,0.832451253482,0.596796657382,0.813509749304
	80,80,80,80,80,80,80,80,80,80,80,80,0.94,0.95,0.94,0.94,0.95,0.94,0.87,0.86,0.85,0.87,0.83,0.87,0.94,0.95,0.94,0.94,0.95,0.94,0.8,0.81,0.54,0.8,0.46,0.83,0.94,0.95,0.94,0.94,0.95,0.94,0.83,0.83,0.63,0.83,0.55,0.85,0.940668523677,0.94860724234,0.943871866295,0.943036211699,0.950417827298,0.944011142061,0.802367688022,0.808077994429,0.7235515320334,0.803760445682,0.461838440111,0.828412256267
	90,90,90,90,90,90,90,90,90,90,90,90,0.94,0.94,0.95,0.95,0.95,0.93,0.86,0.87,0.88,0.87,0.87,0.87,0.94,0.94,0.95,0.95,0.95,0.93,0.8,0.81,0.82,0.8,0.83,0.83,0.94,0.94,0.95,0.95,0.95,0.93,0.82,0.83,0.84,0.83,0.85,0.85,0.937883008357,0.942896935933,0.948050139276,0.94860724234,0.950835654596,0.93217270195,0.80278551532,0.805988857939,0.822144846797,0.798746518106,0.832033426184,0.832729805014
	100,100,100,100,100,100,100,100,100,100,100,100,0.94,0.95,0.95,0.95,0.93,0.95,0.87,0.87,0.87,0.87,0.87,0.87,0.94,0.95,0.95,0.95,0.92,0.95,0.81,0.82,0.83,0.79,0.8,0.83,0.94,0.95,0.95,0.95,0.93,0.95,0.83,0.84,0.85,0.82,0.83,0.84,0.943175487465,0.948885793872,0.947632311978,0.947632311978,0.923816155989,0.948885793872,0.808774373259,0.820891364903,0.833844011142,0.792479108635,0.796239554318,0.825487465181
	110,110,110,110,110,110,110,110,110,110,110,110,0.95,0.94,0.94,0.95,0.95,0.95,0.88,0.87,0.87,0.87,0.85,0.88,0.95,0.95,0.94,0.95,0.95,0.95,0.81,0.73,0.8,0.82,0.65,0.82,0.95,0.94,0.94,0.95,0.95,0.95,0.84,0.78,0.83,0.84,0.72,0.85,0.948746518106,0.945543175487,0.937883008357,0.948467966574,0.947353760446,0.948467966574,0.814902506964,0.726601671309,0.801671309192,0.823676880223,0.654735376045,0.824930362117
	120,120,120,120,120,120,120,120,120,120,120,120,0.94,0.94,0.95,0.94,0.94,0.95,0.87,0.87,0.87,0.86,0.87,0.87,0.94,0.94,0.95,0.94,0.94,0.95,0.79,0.8,0.79,0.79,0.84,0.81,0.94,0.94,0.95,0.94,0.94,0.95,0.82,0.83,0.82,0.82,0.85,0.84,0.942618384401,0.941364902507,0.949860724234,0.944846796657,0.943175487465,0.946657381616,0.793593314763,0.80069637883,0.791504178273,0.788579387187,0.83704735376,0.814902506964
	130,130,130,130,130,130,130,130,130,130,130,130,0.94,0.93,0.95,0.95,0.94,0.94,0.88,0.86,0.87,0.87,0.87,0.87,0.94,0.92,0.95,0.95,0.94,0.94,0.56,0.82,0.78,0.77,0.81,0.8,0.94,0.92,0.95,0.95,0.94,0.94,0.66,0.84,0.82,0.81,0.84,0.82,0.942757660167,0.920891364903,0.94791086351,0.948746518106,0.939554317549,0.935236768802,0.560863509749,0.816573816156,0.781754874652,0.774791086351,0.811559888579,0.795543175487
	140,140,140,140,140,140,140,140,140,140,140,140,0.93,0.95,0.94,0.95,0.95,0.95,0.89,0.87,0.87,0.86,0.87,0.87,0.93,0.95,0.94,0.95,0.95,0.95,0.55,0.83,0.79,0.81,0.83,0.77,0.93,0.95,0.94,0.95,0.95,0.95,0.65,0.85,0.82,0.83,0.84,0.8,0.930362116992,0.947632311978,0.943036211699,0.95069637883,0.951949860724,0.946657381616,0.547493036212,0.82938718663,0.787604456825,0.805431754875,0.828272980501,0.769080779944
	150,150,150,150,150,150,150,150,150,150,150,150,0.95,0.93,0.94,0.94,0.94,0.94,0.88,0.87,0.87,0.87,0.86,0.87,0.95,0.93,0.94,0.94,0.94,0.94,0.39,0.81,0.81,0.69,0.79,0.8,0.95,0.93,0.94,0.94,0.94,0.94,0.47,0.83,0.84,0.76,0.82,0.83,0.949025069638,0.93147632312,0.938718662953,0.941504178273,0.938022284123,0.935793871866,0.391225626741,0.806545961003,0.812813370474,0.694428969359,0.786629526462,0.796378830084
\end{filecontents*}
% [(0, 'linelen216cnn'), (1, 'linelen216rnn'), (2, 'linelen232cnn'), (3, 'linelen232rnn'), (4, 'linelen264cnn'), (5, 'linelen264rnn'), (6, 'linelen516cnn'), (7, 'linelen516rnn'), (8, 'linelen532cnn'), (9, 'linelen532rnn'), (10, 'linelen564cnn'), (11, 'linelen564rnn'), (12, 'prec216cnn'), (13, 'prec216rnn'), (14, 'prec232cnn'), (15, 'prec232rnn'), (16, 'prec264cnn'), (17, 'prec264rnn'), (18, 'prec516cnn'), (19, 'prec516rnn'), (20, 'prec532cnn'), (21, 'prec532rnn'), (22, 'prec564cnn'), (23, 'prec564rnn'), (24, 'rec216cnn'), (25, 'rec216rnn'), (26, 'rec232cnn'), (27, 'rec232rnn'), (28, 'rec264cnn'), (29, 'rec264rnn'), (30, 'rec516cnn'), (31, 'rec516rnn'), (32, 'rec532cnn'), (33, 'rec532rnn'), (34, 'rec564cnn'), (35, 'rec564rnn'), (36, 'f1216cnn'), (37, 'f1216rnn'), (38, 'f1232cnn'), (39, 'f1232rnn'), (40, 'f1264cnn'), (41, 'f1264rnn'), (42, 'f1516cnn'), (43, 'f1516rnn'), (44, 'f1532cnn'), (45, 'f1532rnn'), (46, 'f1564cnn'), (47, 'f1564rnn'), (48, 'acc216cnn'), (49, 'acc216rnn'), (50, 'acc232cnn'), (51, 'acc232rnn'), (52, 'acc264cnn'), (53, 'acc264rnn'), (54, 'acc516cnn'), (55, 'acc516rnn'), (56, 'acc532cnn'), (57, 'acc532rnn'), (58, 'acc564cnn'), (59, 'acc564rnn')]
\begin{figure}
	\centering
	\begin{subfigure}[t]{0.5\textwidth}
		\centering
		\begin{tikzpicture} % 16: 48,49 | 32: 50,51 | 64: 52,53 (cnn,rnn|2zone)
		\begin{axis}[width=0.98\textwidth, height=0.66\textwidth,
		             every tick label/.append style={font=\scriptsize},
		             every label/.append style={font=\scriptsize}, ylabel near ticks,
		             mark options={solid,scale=0.7}, legend style={at={(0.99,0.01)},anchor=south east},
		             xlabel={maximum line length}, ylabel={Accuracy}]
		\addplot[solid, color=black, mark=x] table[x index={0},y index={50}, col sep=comma] {dataevallines.csv};
		\addlegendentry{\tiny CNN};
		\addplot[dashed, color=black, mark=o] table[x index={0},y index={51}, col sep=comma] {dataevallines.csv};
		\addlegendentry{\tiny RNN};
		\end{axis}
		\end{tikzpicture}
		%\caption{Two Zone Model}
	\end{subfigure}%
	~ 
	\begin{subfigure}[t]{0.5\textwidth}
		\centering
		\begin{tikzpicture} % 16: 54,55 | 32: 56,57 | 64: 58,59 (cnn,rnn|5zone)
		\begin{axis}[width=0.98\textwidth, height=0.66\textwidth,
		mark options={solid,scale=0.7}, legend style={at={(0.99,0.01)},anchor=south east},
		every tick label/.append style={font=\scriptsize},
		every label/.append style={font=\scriptsize}, 
		yticklabel pos=right, ylabel near ticks,
		xlabel={maximum line length}, ylabel={Accuracy}]
		\addplot[solid, color=black, mark=x] table[x index={0},y index={56}, col sep=comma] {dataevallines.csv};
		\addlegendentry{\tiny CNN};
		\addplot[dashed, color=black, mark=o] table[x index={0},y index={57}, col sep=comma] {dataevallines.csv};
		\addlegendentry{\tiny RNN};
		\end{axis}
		\end{tikzpicture}
		%\caption{Five Zone Model}
	\end{subfigure}
	\caption{Accuracy of $d$-dimensional line embeddings at increasing maximum line length; tested $d\in\{16, 32, 48, 64\}$, showing $d=32$; Trained using two-zone (left) and five-zone (right) classification}
	\label{fig:gridsearch}
\end{figure}

The ideal configuration for the embedding stage is determined through grid search across mentioned parameters.
We record the accuracy of the CNN and RNN approach for the two zone task as well as the full five zone task as \Fref{fig:gridsearch} shows.
Note, that the CNN model assumes a fixed size input, so shorter lines are zero-padded at the end.
When evaluating the reported accuracy, one has to consider two things.
First, this metric may not project down to the later stage of our system, and second, the line type distribution bias reduces the range of values to 0.8 (or 0.6) upwards.

We did not observe significant differences between embedding dimensions above 32, so we choose this dimensionality in favour of a less complex model.
Most errors are caused by blank lines, which are usually classified as "Body".
Results when training using two-zone classification are mostly stable for both models.
The majority of lines in our training data are between forty and fifty characters long.
Interestingly, we observe a drop in performance of the convolutional model for fixed input lengths just over this average in the five-zone classification.

Both approaches for line representations seem to have their strengths and weaknesses.
Since there is no clear winner, we continue only using the convolutional model in this work.
We do so based on the argument, that one may want to process large corpora and prefers a faster model.

% conv cant handle much padding, rnn better at that
% avg line len 40-50, so choose cnn for simplicity
% robustness?

%\subsection{Flexibility of the Model}
%perturbation resistance
%size of training dataset (how much annotated data needed)
%cross corpus (?)


\section{Experimental Setup}
In this section we present an overview of the email datasets we used and discuss the sampling of emails for an unbiased evaluation.
Further, we describe competing approaches that are used as baselines for comparison of our results.
We also analyse model parameters and its robustness to changes in email text.

\subsection{Dataset}
We evaluate our proposed approach to email zoning on the Enron Corpus~\cite{enron} and emails gathered from public mail archives of the Apache Software Foundation (ASF)\footnote{\url{http://mail-archives.apache.org/mod\_mbox/}}. 
Estival et al. and Lampert et al. discussed shortcomings in working with Usenet-style emails, so we refrain from using the twenty newsgroup dataset as was done for the Jangada system ~\cite{profiling,zones,20news}.
We found that more recent email threads from the ASF archives, especially those on mailinglists for users of different software projects, offer diverse formatting patterns.

Each dataset is divided into three subsets for training, testing, and final evaluation.
Emails are sampled at random from their respective original dataset and put into one of those subsets.
To ensure representative results that are not biased by author or domain, sampling per subset is restricted to distinct mailboxes (Enron) or mailing lists (ASF).
The ASF dataset was compiled by randomly selecting emails from the \textit{flink-user}, \textit{spark-user}, and \textit{lucene-solr-user} mailing list archives.

Prior to sampling from the Enron corpus, duplicates are removed based on sender, recipient(s), and time provided by structured email meta data.
This reduces the corpus almost by 50\%, which confirms the assumption of a full dataset, where an email in one's sent folder is also found in someone else's archive.

\begin{table}
	\caption{Annotated Datasets in Numbers}
	\label{tab:dataset}
	\centering
	\begin{tabular*}{\textwidth}{@{\extracolsep{\fill}} ccccccc}
		\toprule
		& \multicolumn{3}{c}{Enron} &  \multicolumn{3}{c}{ASF} \\
		\cmidrule{2-4}
		\cmidrule{5-7}
		                          & Train    & Test   & Eval   & Train   & Test   & Eval  \\
		\midrule
		Emails                    & 500      & 200    & 100    &  350   &  100   &   50   \\
		Individual messages       & 1048     & 474    & 233    &  934   &  226   &   108  \\
		Average length of threads & 3.5      & 3.6    & 3.5    &  3.5   &  3.7   &   3.1  \\
		Number of Signatures      & 103      & 58     & 26     &  76    &  13    &   5    \\
		\bottomrule
	\end{tabular*}
\end{table}

%##### > ../../DATA/ENRON/ANNOTATED < #####
%=========== Train:
%num mails 500
%num mails - no thread 279
%num mails - with thread 221
%num actual messages 1048
%avg threadlen 2.096
%avg threadlen - nonzero 3.47963800905
%num headers per mail 0: 0.56, 1: 0.16, 2: 0.14, 3: 0.05, 4: 0.04, 5: 0.02, 6: 0.01, 7: 0.01, 8: 0.01, 18: 0.00
%num sigs 103
%avg sig len 6.73786407767
%avg email len (lines) 46.934
%avg message len (lines) 23.4055299539
%=========== Test:
%num mails 200
%num mails - no thread 94
%num mails - with thread 106
%num actual messages 474
%avg threadlen 2.37
%avg threadlen - nonzero 3.58490566038
%num headers per mail 0: 0.47, 1: 0.14, 2: 0.23, 3: 0.07, 4: 0.04, 5: 0.03, 6: 0.02, 7: 0.01, 8: 0.01, 9: 0.01, 15: 0.01
%num sigs 58
%avg sig len 6.81034482759
%avg email len (lines) 42.875
%avg message len (lines) 20.5965909091
%=========== Eval:
%num mails 101
%num mails - no thread 48
%num mails - with thread 53
%num actual messages 233
%avg threadlen 2.30693069307
%avg threadlen - nonzero 3.49056603774
%num headers per mail 0: 0.48, 1: 0.18, 2: 0.22, 3: 0.05, 4: 0.04, 5: 0.01, 6: 0.01, 8: 0.01, 20: 0.01
%num sigs 26
%avg sig len 5.53846153846
%avg email len (lines) 42.0594059406
%avg message len (lines) 20.3579545455
%
%##### > ../../DATA/ASF/ANNOTATED < #####
%=========== Train:
%num mails 358
%num mails - no thread 132
%num mails - with thread 226
%num actual messages 934
%avg threadlen 2.60893854749
%avg threadlen - nonzero 3.54867256637
%num headers per mail 0: 0.37, 1: 0.26, 2: 0.15, 3: 0.08, 4: 0.06, 5: 0.02, 6: 0.03, 7: 0.01, 8: 0.01, 9: 0.00, 10: 0.00, 11: 0.00, 13: 0.00
%num sigs 76
%avg sig len 6.28947368421
%avg email len (lines) 68.7988826816
%avg message len (lines) 26.1347438753
%=========== Test:
%num mails 91
%num mails - no thread 41
%num mails - with thread 50
%num actual messages 226
%avg threadlen 2.48351648352
%avg threadlen - nonzero 3.7
%num headers per mail 0: 0.45, 1: 0.22, 2: 0.11, 3: 0.07, 4: 0.05, 5: 0.03, 6: 0.02, 7: 0.02, 8: 0.02
%num sigs 13
%avg sig len 6.15384615385
%avg email len (lines) 66.8351648352
%avg message len (lines) 24.1651785714
%=========== Eval:
%num mails 45
%num mails - no thread 16
%num mails - with thread 29
%num actual messages 108
%avg threadlen 2.4
%avg threadlen - nonzero 3.1724137931
%num headers per mail 0: 0.36, 1: 0.33, 2: 0.13, 3: 0.09, 4: 0.02, 6: 0.02, 7: 0.04
%num sigs 5
%avg sig len 5.8
%avg email len (lines) 64.8666666667
%avg message len (lines) 26.4166666667

\Fref{tab:dataset} shows an overview of the selected dataset and the expected number of messages to be extracted.
Prior heuristic analysis of the Enron corpus estimated 60\% of emails to contain conversation threads~\cite{enron}, which is close to our annotated data.
On average an email has two parts with 20 lines per message.
Only a few messages contain a signature, which on average are six lines long.

Our selected subsets of the Enron corpus are annotated with spans of characters nested by level of detail of their type.
Hereby the most coarse span types are headers and bodies.
Span types within a header are Subject, Person Name, Email Address, Date, and Time.
Within a body the following span types are annotated: Greeting and Signoff, Person Name within those, and Signatures. Signatures are further broken down into Name, Organisation, Addresses, Phone Numbers, Attachments, and Disclaimers.

Spans containing names (or email addresses) are linked as alias if they refer to the same person.
Other supplementary information such as organisations a person works for or contact details are also linked accordingly.
Although this level of detail exceeds the requirements for the objective of this paper, it provides valuable data for future work and research on social networks, speech acts, or other tasks surrounding email\footnote{Different versions of the dataset are published our web page:\\ \url{https://url-remov.ed/for/review}}.

%We hope to inspire future work in the area [knowledge graph]

% describe how data is selected from enron corpus (800: 500 train, 200 test, 100 eval)
% annotated very detailed, even with some entity linking and signature parts, considered level of detail: header, body, signature, intro/outro; one annotator
% some numbers comparing raw data and contained information in \Fref{tab:dataset}
% based on subject and sender/recipient around 60% threads\cite{enron}
% we removed duplicates based users and time, about 50%
% https://hpi.de//naumann/projects/web-science/business-communication-analysis/email-structure.html
% https://github.com/TimRepke/email-splitting


\subsection{Competing Approaches}
We compare our proposed model for extracting zones from emails against several other approaches.
Most notably, Jangada and Zebra~\cite{zones,signature} are reimplemented with slight modifications to fit the more refined problem statement.
Both systems originally are intended to distinguish lines within an email, which are not part of the latest message of that thread.
Clearly that deviates from our goal to extract \textit{all} individual parts and detect zones with additional detail within those.
Since the systems are supposed to detect zones within the first part of the email, their features and underlying models should in principle also work on our task.

The source code for Jangada is freely available on the author's web page\footnote{\url{http://www.cs.cmu.edu/~vitor/software/jangada/}}.
We used the source code as a basis for an implementation in Python, however continue to use the the same implementation of the Collins Perceptron for sequence labelling, which is part of the MinorThird Library~\cite{minorthird,cperceptron}.
For the extraction of signatures, Jangada originally only considers the last ten lines of an email.
In our implementation, the perceptron performs a multi-class classification along all lines of the email corresponding to zone types defined earlier.

The Zebra project web page\footnote{\url{http://zebra.thoughtlets.org/zoning.php}} does only provide annotated data, but not the system's source code. 
Gossen et al. implemented\footnote{\url{https://github.com/gerhardgossen/soZebra}} it for their work on classification of action items in emails~\cite{sozebra}.
We used that as a guideline for our adapted Python implementation.

Both models originally weren't designed to find the inherent structure of an entire email, but rather only the latest message in a conversation along with zones within it.
It seems fair to assume, that the approaches for zoning the last message in an email should easily transfer to following messages as well.
We use a selection of features from both models is taken as input for a recurrent neural network with two GRU layers~\cite{gru}, which will be referred to as \textit{FeatureRNN}.

We compare those to our proposed model as described in \Fref{sec:model} using convolutions in the first stage.

% baseline (regex+rules)
% reimplement zebra\footnote{\url{http://zebra.thoughtlets.org/zoning.php}} https://github.com/gerhardgossen/soZebra
% jangada\footnote{\url{http://www.cs.cmu.edu/~vitor/software/jangada/}}
% describe differences, what needs to be changed to make it fair
% RNN with features
% show which task is more or less comparable between all


\section{Results}
evaluate different complexities: full task (get all information), split head+body, additionally split body parts (sig, intro, outro)

results in \Fref{tab:results-comp} and \Fref{tab:results}

\begin{table}
	\centering
	\caption{Results of Two-Zone Task}
	\label{tab:results-comp}
	\begin{tabular}{|c|cc|}
		\hline
		Approach & Dataset& result\\ \hline
		We 1& a & 0.98\\
		We 2& a & 0.98\\
		We 3& a & 0.98\\
		Zebra\cite{zones} & d & 0.78\\
		Jangada\cite{signature} & d & 0.8\\
		\hline	
	\end{tabular}
\end{table}

\begin{table}
	\centering
	\caption{Experimental Results}
	\label{tab:results}
	\begin{tabular}{|c|cc|}
		\hline
		task & prec/rec& f1\\ \hline
		2zone& a & 0.98\\
		5zone& a & 0.98\\
		full& a & 0.98\\
		\hline	
	\end{tabular}
\end{table}

\Fref{fig:mpd} shows influence of extracting information vs using raw data

\begin{figure}
	\centering
	\begin{subfigure}[t]{0.5\textwidth}
		\centering
		\dummyfig{0.17}{0.9}{xaxis=timebuckets, yaxis=freq} 
		\caption{raw data}
	\end{subfigure}%
	~ 
	\begin{subfigure}[t]{0.5\textwidth}
		\centering
		\dummyfig{0.17}{0.9}{xaxis=timebuckets, yaxis=freq} 
		\caption{extracted data}
	\end{subfigure}
	\caption{Mail Frequency}
	\label{fig:mpd}
\end{figure}


maybe: email classification with+without splitting (i.e. try to classify folders)

\section{Conclusion and Future Work}
nicht nur für mails, auch forenthreads und andere semi-strukturierte daten

% novel clean dataset for email research on enron
% flexible model to clean up large amounts of email data


\bibliographystyle{splncs03}
\bibliography{biblio} 
\end{document}
